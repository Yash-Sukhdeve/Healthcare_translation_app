<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Healthcare Translation App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Arial', sans-serif; background-color: #f8f9fa; }
    .container-custom { max-width: 800px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .section { margin-bottom: 2rem; }
    .status-indicator { display: none; }
    #audioPlayback { display: none; width: 100%; margin-top: 1rem; }
  </style>
</head>
<body class="py-4">
<div class="container container-custom p-4">
  <h1 class="text-center mb-4">Healthcare Translation App</h1>
  
  <!-- Recording Section -->
  <div class="section text-center">
    <h3>Record Audio</h3>
    <button id="recordButton" class="btn btn-primary">Start Recording</button>
    <div id="recordingStatus" class="status-indicator mt-2">
      <div class="spinner-border spinner-border-sm" role="status"></div>
      <span>Recording...</span>
    </div>
    <div id="uploadStatus" class="status-indicator mt-2">
      <div class="spinner-border spinner-border-sm" role="status"></div>
      <span>Processing...</span>
    </div>
    <div id="recordingError" class="text-danger mt-2"></div>
    <audio id="audioPlayback" controls></audio>
  </div>
  
  <!-- Transcription -->
  <div class="section">
    <h5>Original Transcript:</h5>
    <div id="transcriptText" class="border p-3 bg-light rounded"></div>
  </div>
  
  <!-- Translation -->
  <div class="section text-center">
    <h3>Translate</h3>
    <select id="languageSelect" class="form-select w-50 mx-auto mb-3">
      <option value="Spanish">Spanish</option>
      <option value="French">French</option>
      <option value="German">German</option>
      <option value="Chinese">Chinese</option>
      <option value="Japanese">Japanese</option>
    </select>
    <button id="translateButton" class="btn btn-info" disabled>Translate</button>
    <div id="translationStatus" class="status-indicator mt-2">
      <div class="spinner-border spinner-border-sm" role="status"></div>
      <span>Translating...</span>
    </div>
    <div id="translationError" class="text-danger mt-2"></div>
  </div>
  
  <!-- Results -->
  <div class="section">
    <h5>Translated Transcript:</h5>
    <div id="translatedText" class="border p-3 bg-light rounded"></div>
    <div class="text-center mt-3">
      <button id="speakButton" class="btn btn-success" disabled>Speak</button>
    </div>
  </div>
</div>

<script>
  // State Management
  const state = {
    mediaRecorder: null,
    audioBlob: null,
    transcript: ""
  };

  // DOM Elements
  const elements = {
    recordButton: document.getElementById('recordButton'),
    audioPlayback: document.getElementById('audioPlayback'),
    transcriptText: document.getElementById('transcriptText'),
    translateButton: document.getElementById('translateButton'),
    translatedText: document.getElementById('translatedText'),
    speakButton: document.getElementById('speakButton'),
    languageSelect: document.getElementById('languageSelect'),
    recordingStatus: document.getElementById('recordingStatus'),
    uploadStatus: document.getElementById('uploadStatus'),
    translationStatus: document.getElementById('translationStatus'),
    recordingError: document.getElementById('recordingError'),
    translationError: document.getElementById('translationError')
  };

  // Helper Functions
  const toggleElement = (element, show) => element.style.display = show ? 'block' : 'none';
  const setButtonState = (button, enabled) => button.disabled = !enabled;
  const clearError = (element) => element.textContent = '';

  // Recording Handlers
  elements.recordButton.addEventListener('click', async () => {
    if (!state.mediaRecorder) {
      startRecording();
    } else {
      stopRecording();
    }
  });

  async function startRecording() {
    try {
      clearError(elements.recordingError);
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      state.mediaRecorder = new MediaRecorder(stream);
      state.audioChunks = [];
      
      state.mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) state.audioChunks.push(e.data);
      };
      
      state.mediaRecorder.onstop = processRecording;
      state.mediaRecorder.start();
      
      elements.recordButton.textContent = "Stop Recording";
      toggleElement(elements.recordingStatus, true);
      setButtonState(elements.translateButton, false);
    } catch (err) {
      elements.recordingError.textContent = "Could not access microphone";
      console.error("Recording error:", err);
    }
  }

  function stopRecording() {
    if (state.mediaRecorder) {
      state.mediaRecorder.stop();
      state.mediaRecorder.stream.getTracks().forEach(track => track.stop());
    }
  }

  async function processRecording() {
    toggleElement(elements.recordingStatus, false);
    toggleElement(elements.uploadStatus, true);
    
    state.audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
    elements.audioPlayback.src = URL.createObjectURL(state.audioBlob);
    toggleElement(elements.audioPlayback, true);
    
    try {
      const formData = new FormData();
      formData.append('audio_data', state.audioBlob, 'recording.webm');
      
      const response = await fetch('/upload', {
        method: 'POST',
        body: formData
      });
      
      if (!response.ok) throw new Error('Upload failed');
      
      const data = await response.json();
      if (data.transcript) {
        state.transcript = data.transcript;
        elements.transcriptText.textContent = state.transcript;
        setButtonState(elements.translateButton, true);
      }
    } catch (err) {
      elements.recordingError.textContent = "Failed to process audio";
      console.error("Upload error:", err);
    } finally {
      toggleElement(elements.uploadStatus, false);
      elements.recordButton.textContent = "Start Recording";
      state.mediaRecorder = null;
    }
  }

  // Translation Handler
  elements.translateButton.addEventListener('click', async () => {
    if (!state.transcript) return;
    
    clearError(elements.translationError);
    toggleElement(elements.translationStatus, true);
    
    try {
      const response = await fetch('/translate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          text: state.transcript,
          targetLanguage: elements.languageSelect.value
        })
      });
      
      if (!response.ok) throw new Error('Translation failed');
      
      const data = await response.json();
      if (data.translatedText) {
        elements.translatedText.textContent = data.translatedText;
        setButtonState(elements.speakButton, true);
      }
    } catch (err) {
      elements.translationError.textContent = "Translation service unavailable";
      console.error("Translation error:", err);
    } finally {
      toggleElement(elements.translationStatus, false);
    }
  });

  // Text-to-Speech
  elements.speakButton.addEventListener('click', () => {
    const text = elements.translatedText.textContent;
    if (!text) return;
    
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = elements.languageSelect.value === 'Spanish' ? 'es-ES' : 'en-US';
    window.speechSynthesis.speak(utterance);
  });
</script>
</body>
</html>